<!DOCTYPE html><html><head><title>riskTree.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../coffee/main.coffee.html" class="source "><span class="base_path">coffee / </span><span class="file_name">main.coffee</span></a><a href="../coffee/riskTree.coffee.html" class="source selected"><span class="base_path">coffee / </span><span class="file_name">riskTree.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>riskTree.coffee</h1><div class="filepath">coffee/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><!-- JSHint directives are *not* annotations.
##global define###
-->

<h1>RiskTree</h1>

<p>Handles drawing and updating a d3js tree diagram of the risk structure.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Almost identical to <a href="https://github.com/mbostock">Mike Bostock</a>'s <a href="http://mbostock.github.com/d3/talk/20111018/tree.html">D3 tree example</a>.
I've converted to CoffeeScript and annotated the source, as well as doing some minor refactoring.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Load the d3 libarary and the d3.layout plugin</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span><span class="p">([</span><span class="s">&#39;d3layout&#39;</span><span class="p">],</span> <span class="nf">(d3) -&gt;</span>
  <span class="s">&#39;use strict&#39;</span>
  </pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><h2>Constants</h2>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">maxLabelLength = </span><span class="mi">30</span>
  <span class="nv">nodeRadius = </span><span class="mi">5</span>
  <span class="nv">characterWidth = </span><span class="mi">7</span>
  </pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><h2>Helper methods</h2>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">hasChildren = </span><span class="nf">(node) -&gt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span> <span class="o">and</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
  </pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Used to work out how much space on the right we need to leave for the labels.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">getLengthOfLongestLabelOnDeepestLevel = </span><span class="p">(</span><span class="nf">() -&gt;</span>
    </pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>This function will be called recursively for each branch of the tree.
We can keep it private to this closure.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">getDepthAndLength = </span><span class="nf">(data, depth) -&gt;</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>If <code>depth</code> is not provided, start with 1</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">depth = </span><span class="mi">1</span> <span class="nx">unless</span> <span class="nx">depth</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p><code>length</code> is the number of characters in the node's name</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">length = </span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">length</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>If this node has no children then we already have the correct data for this branch.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">return</span> <span class="p">[</span><span class="nx">depth</span><span class="p">,</span> <span class="nx">length</span><span class="p">]</span> <span class="nx">unless</span> <span class="nx">hasChildren</span> <span class="nx">data</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Otherwise we want the depth of the deepest child branch</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">maxDepth = </span><span class="nx">depth</span>
      <span class="nv">maxLength = </span><span class="nx">length</span>
      <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">data</span><span class="p">.</span><span class="nx">children</span>
        <span class="p">[</span><span class="nx">newDepth</span><span class="p">,</span> <span class="nx">newLength</span><span class="p">]</span> <span class="o">=</span> <span class="nx">getDepthAndLength</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">depth</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nx">newDepth</span> <span class="o">&gt;</span> <span class="nx">maxDepth</span>
          <span class="nv">maxDepth = </span><span class="nx">newDepth</span>
          <span class="nv">maxLength = </span><span class="nx">newLength</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">newDepth</span> <span class="o">==</span> <span class="nx">maxDepth</span> <span class="o">and</span> <span class="nx">newLength</span> <span class="o">&gt;</span> <span class="nx">maxLength</span>
          <span class="nv">maxLength = </span><span class="nx">newLength</span>
      <span class="k">return</span> <span class="p">[</span><span class="nx">maxDepth</span><span class="p">,</span> <span class="nx">maxLength</span><span class="p">]</span>
    </pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>We're not actually interested in the <code>depth</code>, since d3 works all that out for us.
Return a wrapper that does not expose that information.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="nf">(data) -&gt;</span>
      <span class="p">[</span><span class="nx">depth</span><span class="p">,</span> <span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="nx">getDepthAndLength</span> <span class="nx">data</span>
      <span class="k">return</span> <span class="nx">length</span>
  <span class="p">)()</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><h2>Draw</h2>

<p>Takes in a selector and some data and draws a
tree in the element the selector points at.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">draw = </span><span class="nf">(selector, data) -&gt;</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>First lets run the selector and store the result for later</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">$target = </span><span class="nx">$</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span>
    </pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>We need to know the length of the first label so that we know how much space to leave on the left.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">leftOffset = </span><span class="mi">10</span> <span class="o">+</span> <span class="k">if</span> <span class="nx">hasChildren</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="k">then</span> <span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="nx">characterWidth</span> <span class="k">else</span> <span class="mi">0</span>
    </pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>We also need to know the length of the longest label on the last row, so that we know how wide we can make the thing.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">maxLength = </span><span class="nx">getLengthOfLongestLabelOnDeepestLevel</span> <span class="nx">data</span>
    <span class="nv">rightOffset = </span><span class="mi">10</span> <span class="o">+</span> <span class="nx">maxLength</span> <span class="o">*</span> <span class="nx">characterWidth</span>
    </pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>Get the size of the element</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">size = </span>
      <span class="nv">width: </span><span class="nx">$target</span><span class="p">.</span><span class="nx">width</span><span class="p">()</span>
      <span class="nv">height: </span><span class="nx">$target</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span>
    </pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>Create the tree</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">tree = </span><span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">tree</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">size</span><span class="p">([</span><span class="nx">size</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="nx">size</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">leftOffset</span> <span class="o">-</span> <span class="nx">rightOffset</span><span class="p">])</span>
      <span class="p">.</span><span class="nx">children</span> <span class="nf">(node) -&gt;</span> <span class="k">if</span> <span class="nx">hasChildren</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="k">then</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span> <span class="k">else</span> <span class="kc">null</span> 
    </pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>Create the nodes and links</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">nodes = </span><span class="nx">tree</span><span class="p">.</span><span class="nx">nodes</span> <span class="nx">data</span>
    <span class="nv">links = </span><span class="nx">tree</span><span class="p">.</span><span class="nx">links</span> <span class="nx">nodes</span>
    </pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>Add the top level SVG (i.e. a container <code>group</code>)</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">layoutRoot = </span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s">&#39;svg:svg&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;width&#39;</span><span class="p">,</span> <span class="nx">size</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;height&#39;</span><span class="p">,</span> <span class="nx">size</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s">&#39;svg:g&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>Budge the thing across by a bit</p>
</td><td class="code"><div class="highlight"><pre>      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;transform&#39;</span><span class="p">,</span> <span class="s">&#39;translate(&#39;</span> <span class="o">+</span> <span class="nx">leftOffset</span> <span class="o">+</span> <span class="s">&#39;,0)&#39;</span><span class="p">)</span>
    </pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>Use the <code>diagonal</code> projection for links between nodes</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">link = </span><span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">diagonal</span><span class="p">().</span><span class="nx">projection</span> <span class="nf">(node) -&gt;</span> <span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span>
    </pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>Draw the links</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">layoutRoot</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s">&#39;path.link&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">links</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s">&#39;svg:path&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;class&#39;</span><span class="p">,</span> <span class="s">&#39;link&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="nx">link</span><span class="p">)</span>
    </pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>Draw the nodes (groups to hold the text and circle)</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">nodeGroup = </span><span class="nx">layoutRoot</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s">&#39;g.node&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">nodes</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s">&#39;svg:g&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;class&#39;</span><span class="p">,</span> <span class="s">&#39;node&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;transform&#39;</span><span class="p">,</span> <span class="nf">(node) -&gt;</span> <span class="s">&#39;translate(&#39;</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="s">&#39;,&#39;</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span><span class="p">)</span>
    </pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>Draw the circle</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">nodeGroup</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s">&#39;svg:circle&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="nx">nodeRadius</span><span class="p">)</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>Draw the text</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">nodeGroup</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s">&#39;svg:text&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>Text placement should depend on whether the node has any children</p>
</td><td class="code"><div class="highlight"><pre>      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;text-anchor&#39;</span><span class="p">,</span> <span class="nf">(d) -&gt;</span> <span class="k">if</span> <span class="nx">hasChildren</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="k">then</span> <span class="s">&#39;end&#39;</span> <span class="k">else</span> <span class="s">&#39;start&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;dx&#39;</span><span class="p">,</span> <span class="nf">(d) -&gt;</span> <span class="k">if</span> <span class="nx">hasChildren</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="k">then</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="nx">nodeRadius</span> <span class="k">else</span> <span class="mi">2</span><span class="o">*</span><span class="nx">nodeRadius</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;dy&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nf">(d) -&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
  
  <span class="nv">Draw: </span><span class="nx">draw</span><span class="p">,</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>We're only making this public so that it can be unit tested.
Perhaps it should really go in its own module.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">GetLengthOfLongestLabelOnDeepestLevel: </span><span class="nx">getLengthOfLongestLabelOnDeepestLevel</span>
<span class="p">)</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><h1>Todo</h1>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr></tbody></table><div id="generated">generated Sun Dec 09 2012 13:44:08 GMT+0000 (GMT)  </div></div></body></html>