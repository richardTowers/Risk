<!DOCTYPE html><html><head><title>riskTree.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../coffee/main.coffee.html" class="source "><span class="base_path">coffee / </span><span class="file_name">main.coffee</span></a><a href="../coffee/riskTree.coffee.html" class="source selected"><span class="base_path">coffee / </span><span class="file_name">riskTree.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>riskTree.coffee</h1><div class="filepath">coffee/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><h2>global require</h2>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><h1>RiskTree</h1>

<p>Handles drawing and updating a d3js tree diagram of the risk structure.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Load the d3 libarary and the d3.layout plugin</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">require</span><span class="p">([</span><span class="s">&#39;d3layout&#39;</span><span class="p">],</span> <span class="nf">(d3) -&gt;</span>
  <span class="s">&quot;use strict&quot;</span>
  </pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><h2>Update</h2>

<p>A function to redraw the tree object after its state has changed.</p>
</td><td class="code"><div class="highlight"><pre>  
  <span class="nv">update = </span><span class="nf">(source) -&gt;</span>
    <span class="nv">duration = </span><span class="mi">500</span>
    
    <span class="nv">nodes = </span><span class="nx">tree</span><span class="p">.</span><span class="nx">nodes</span><span class="p">(</span><span class="nx">root</span><span class="p">)</span>
    
    <span class="nx">nodes</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(d) -&gt;</span>
      <span class="nv">d.y = </span><span class="nx">d</span><span class="p">.</span><span class="nx">depth</span> <span class="o">*</span> <span class="mi">180</span>

    <span class="nv">node = </span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s">&quot;g.node&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nf">(d) -&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">id</span> <span class="o">or</span> <span class="p">(</span><span class="nv">d.id = </span><span class="o">++</span><span class="nx">i</span><span class="p">))</span>
    
    <span class="nv">nodeEnter = </span><span class="nx">node</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s">&quot;svg:g&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;class&quot;</span><span class="p">,</span> <span class="s">&quot;node&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;transform&quot;</span><span class="p">,</span> <span class="nf">() -&gt;</span>
        <span class="s">&quot;translate(&quot;</span> <span class="o">+</span> <span class="nx">source</span><span class="p">.</span><span class="nx">y0</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">source</span><span class="p">.</span><span class="nx">x0</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="kc">on</span><span class="p">(</span><span class="s">&quot;click&quot;</span><span class="p">,</span> <span class="nf">(d) -&gt;</span>
        <span class="nx">toggle</span> <span class="nx">d</span>
        <span class="nx">update</span> <span class="nx">d</span><span class="p">)</span>
        
    <span class="nx">nodeEnter</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s">&quot;svg:circle&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span> <span class="s">&quot;fill&quot;</span><span class="p">,</span> <span class="nf">(d) -&gt;</span> <span class="p">(</span><span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">_children</span> <span class="k">then</span> <span class="s">&quot;salmon&quot;</span> <span class="k">else</span> <span class="s">&quot;</span><span class="err">#</span><span class="s">fff&quot;</span><span class="p">)</span>

    <span class="nx">nodeEnter</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s">&quot;svg:text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="nf">(d) -&gt;</span> <span class="p">(</span><span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">children</span> <span class="o">or</span> <span class="nx">d</span><span class="p">.</span><span class="nx">_children</span> <span class="k">then</span> <span class="o">-</span><span class="mi">10</span> <span class="k">else</span> <span class="mi">10</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;dy&quot;</span><span class="p">,</span> <span class="s">&quot;.35em&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;text-anchor&quot;</span><span class="p">,</span> <span class="nf">(d) -&gt;</span> <span class="p">(</span><span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">children</span> <span class="o">or</span> <span class="nx">d</span><span class="p">.</span><span class="nx">_children</span> <span class="k">then</span> <span class="s">&quot;end&quot;</span> <span class="k">else</span> <span class="s">&quot;start&quot;</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nf">(d) -&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span> <span class="s">&quot;fill-opacity&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span>
    
    <span class="nv">nodeUpdate = </span><span class="nx">node</span><span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;transform&quot;</span><span class="p">,</span> <span class="nf">(d) -&gt;</span> <span class="s">&quot;translate(&quot;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">)</span>
    
    <span class="nx">nodeUpdate</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s">&quot;circle&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span> <span class="s">&quot;fill&quot;</span><span class="p">,</span> <span class="nf">(d) -&gt;</span> <span class="p">(</span><span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">_children</span> <span class="k">then</span> <span class="s">&quot;salmon&quot;</span> <span class="k">else</span> <span class="s">&quot;</span><span class="err">#</span><span class="s">fff&quot;</span><span class="p">)</span>

    <span class="nx">nodeUpdate</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span> <span class="s">&quot;fill-opacity&quot;</span><span class="p">,</span> <span class="mi">1</span>
    
    <span class="nv">nodeExit = </span><span class="nx">node</span><span class="p">.</span><span class="nx">exit</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;transform&quot;</span><span class="p">,</span> <span class="nf">() -&gt;</span> <span class="s">&quot;translate(&quot;</span> <span class="o">+</span> <span class="nx">source</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">source</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">remove</span><span class="p">()</span>
      
    <span class="nx">nodeExit</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s">&quot;circle&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span>
    <span class="nx">nodeExit</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s">&quot;text&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span> <span class="s">&quot;fill-opacity&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span>
    
    <span class="nv">link = </span><span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s">&quot;path.link&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">tree</span><span class="p">.</span><span class="nx">links</span><span class="p">(</span><span class="nx">nodes</span><span class="p">),</span> <span class="nf">(d) -&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    
    <span class="nx">link</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="s">&quot;svg:path&quot;</span><span class="p">,</span> <span class="s">&quot;g&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;class&quot;</span><span class="p">,</span> <span class="s">&quot;link&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="nf">() -&gt;</span>
        <span class="nv">o =</span>
          <span class="nv">x: </span><span class="nx">source</span><span class="p">.</span><span class="nx">x0</span>
          <span class="nv">y: </span><span class="nx">source</span><span class="p">.</span><span class="nx">y0</span>
        <span class="nx">diagonal</span> <span class="p">{</span><span class="nv">source: </span><span class="nx">o</span><span class="p">,</span><span class="nv">target: </span><span class="nx">o</span><span class="p">})</span>
      <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="nx">diagonal</span>
    
    <span class="nx">link</span><span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="nx">diagonal</span>
    
    <span class="nx">link</span><span class="p">.</span><span class="nx">exit</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="nf">() -&gt;</span>
        <span class="nv">o =</span>
          <span class="nv">x: </span><span class="nx">source</span><span class="p">.</span><span class="nx">x0</span>
          <span class="nv">y: </span><span class="nx">source</span><span class="p">.</span><span class="nx">y0</span>
        <span class="nx">diagonal</span> <span class="p">{</span><span class="nv">source: </span><span class="nx">o</span><span class="p">,</span><span class="nv">target: </span><span class="nx">o</span><span class="p">})</span>
      <span class="p">.</span><span class="nx">remove</span><span class="p">()</span>
    
    <span class="nx">nodes</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(d) -&gt;</span>
      <span class="nv">d.x0 = </span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span>
      <span class="nv">d.y0 = </span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span>
      </pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><h2>Toggle</h2>

<p>Toggle the visibility of this node's children
Note: You will have to call <code>update</code> to display the changes.  </p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">toggle = </span><span class="nf">(d) -&gt;</span>
    <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">children</span>
      <span class="nv">d._children = </span><span class="nx">d</span><span class="p">.</span><span class="nx">children</span>
      <span class="nv">d.children = </span><span class="kc">null</span>
    <span class="k">else</span>
      <span class="nv">d.children = </span><span class="nx">d</span><span class="p">.</span><span class="nx">_children</span>
      <span class="nv">d._children = </span><span class="kc">null</span>
  
  <span class="nv">margin =</span>
    <span class="nv">top: </span><span class="mi">20</span>
    <span class="nv">left: </span><span class="mi">120</span>
    <span class="nv">bottom: </span><span class="mi">20</span>
    <span class="nv">right: </span><span class="mi">120</span>
  
  <span class="nv">width = </span><span class="mi">1130</span> <span class="o">-</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">right</span>
  <span class="nv">height = </span><span class="mi">1000</span> <span class="o">-</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">bottom</span>
  <span class="nv">i = </span><span class="mi">0</span>
  <span class="nv">root = </span><span class="kc">undefined</span>
  <span class="nv">tree = </span><span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">tree</span><span class="p">().</span><span class="nx">size</span><span class="p">([</span><span class="nx">height</span><span class="p">,</span> <span class="nx">width</span><span class="p">])</span>
  <span class="nv">diagonal = </span><span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span>
    <span class="p">.</span><span class="nx">diagonal</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">projection</span><span class="p">(</span><span class="nf">(d) -&gt;</span> <span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">])</span>
    
  <span class="nv">vis = </span><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">riskTree&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s">&quot;svg:svg&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;width&quot;</span><span class="p">,</span> <span class="nx">width</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">right</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;height&quot;</span><span class="p">,</span> <span class="nx">height</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">bottom</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s">&quot;svg:g&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;transform&quot;</span><span class="p">,</span> <span class="s">&quot;translate(&quot;</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">right</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">)</span>
    
  <span class="nx">d3</span><span class="p">.</span><span class="nx">json</span> <span class="s">&quot;flare.json&quot;</span><span class="p">,</span> <span class="nf">(json) -&gt;</span>
    <span class="nv">toggleAll = </span><span class="nf">(d) -&gt;</span>
      <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">children</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span> <span class="nx">toggleAll</span>
        <span class="nx">toggle</span> <span class="nx">d</span>
    <span class="nv">root = </span><span class="nx">json</span>
    <span class="nv">root.x0 = </span><span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="nv">root.y0 = </span><span class="mi">0</span>
    <span class="nx">update</span> <span class="nx">root</span>
<span class="p">)</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Sun Sep 16 2012 22:31:11 GMT+0100 (BST)  </div></div></body></html>